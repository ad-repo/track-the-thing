# Track the Thing - AI Rules (v2.0)

## Critical Rules (Never Violate)

### Safety
- NEVER change program code to fix tests - fix tests or understand why they fail
- NEVER modify/delete working code without full understanding
- NEVER push without running `./test_ci_locally.sh` (exit code must be 0)
- NEVER introduce new patterns when existing ones exist
- NEVER guess at CI errors - read actual logs

### Testing
- NEVER run tests directly - use containerized `./run_all_tests.sh`
- ALWAYS add tests for new functionality (in top-level `tests/` folder)
- ALWAYS run full test suite before committing

### Database
- ALWAYS create migrations in `backend/migrations/` for schema changes
- ALWAYS update `backend/app/routers/backup.py` for data model changes
- ALWAYS test migrations can upgrade from previous versions

## Workflow

### Before Starting
1. Read request completely
2. Search for existing patterns (`grep -r "pattern" backend/` or `frontend/`)
3. Follow existing patterns exactly

### Before Committing
1. Run linter, fix all errors
2. Run `./test_ci_locally.sh` - must pass
3. Check `git diff` - only relevant changes
4. Update docs if behavior changed
5. Add migrations if schema changed

## Code Standards

### Frontend (React/TypeScript)
- Use theme variables: `var(--color-*)` - never hardcode colors
- Use existing hooks/contexts
- Keep TypeScript strict, avoid `any`
- No `console.log` in production
- Clean up effects/listeners

### Backend (Python/FastAPI)
- Follow existing router patterns
- Use existing session patterns
- Consistent error handling

### General
- Match existing naming/structure
- Keep functions < 50 lines
- No debug code or commented-out code

## File Locations

```
backend/app/routers/     # API endpoints
backend/app/models.py    # Database models
backend/migrations/      # DB migrations
frontend/src/components/ # React components
frontend/src/contexts/   # React contexts
frontend/src/hooks/      # Custom hooks
tests/backend/           # Backend tests
tests/e2e/               # E2E tests
```

## Common Tasks

### Add Feature
1. Find similar feature, copy pattern
2. Add tests
3. Update docs
4. Create migration if DB changes

### Fix Bug
1. Write test reproducing bug
2. Fix code (minimal change)
3. Verify test passes
4. Check no regressions

## Don't Do

- "While I'm here..." - stay focused on task
- Refactor unrelated code
- Add features not requested
- Skip documentation updates
- Skip test creation

## When Uncertain

1. State your understanding
2. List assumptions
3. Ask for confirmation
